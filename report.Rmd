---
title: "Cross-selling in Banking"
author: Adrian Meier, Benjamin Wuermli
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
    toc_float: true
  html_notebook:
    toc: yes
    toc_depth: 4
    df_print: paged
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    theme: united
    highlight: tango
    code_folding: show
---

### Imports
```{r}
# install.packages("tidyverse")
# install.packages("ggmosaic")


library(tidyverse)
library(ggmosaic)
```
# Verfügbare Tabellen untersuchen

## account Datensatz
```{r}
accounts <- read.csv("data/account.csv", sep=";")
glimpse(accounts)
summary(accounts)
sum(is.na(accounts))
length(unique(accounts$account_id)) == nrow(accounts)
```

Im ersten schritt wollen wir die Daten der Tabelle accounts verständlicher machen. Dabei wollen wir die tschechischen Namen in der Kategorie "frequency" auf Deutsch übersetzen und con einem <chr> in einen <fct> umwandeln  und das Datum in das richtige Format bringen.
```{r}
#Ändern der tschechischen Namen in der Spalte frequency
accounts <- accounts %>%
  mutate(frequency = case_when(frequency == "POPLATEK MESICNE" ~ "Monatliche Ausgabe",
                               frequency == "POPLATEK TYDNE" ~ "Wöchentliche Ausgabe",
                               frequency == "POPLATEK PO OBRATU" ~ "Ausgabe nach Transaktion"))
```

```{r}
#Frequency in Faktor umwandeln
accounts <- accounts %>% 
  mutate(frequency = as.factor(frequency))
```

```{r}
# Datum umwandeln
accounts$date <- ymd(accounts$date)

# spalten umbenennen
accounts <- accounts %>%
  rename(opening_date = date,
         frequency_of_statements = frequency,
         district_id_account = district_id)
```

Die Werte sind nun bereinigt und man sieht bei frequency die drei Ausgabedaten, zudem ist das Datum nun auch als Datum erfasst.
```{r}
glimpse(accounts)
summary(accounts)
```
```{r}
barplot(table(accounts$district_id), main = "Distribution of Accounts by District", xlab = "District ID", ylab = "Number of Accounts")
```

```{r}
ggplot(accounts, aes(x = frequency_of_statements, fill = frequency_of_statements)) +
  geom_bar() +
  geom_text(stat = 'count', aes(label = ..count..), position = position_stack(vjust = 0.5)) +
  coord_flip() +
  labs(x = "Frequenz", y = "Anzahl Konten", title = "Frequenz der Kontoauszüge", fill = "Ausgabe")
```

## card Datensatz
```{r}
card <- read.csv("data/card.csv", sep=";")
glimpse(card)
summary(card)
sum(is.na(card))
length(unique(card$card_id)) == nrow(card)
```

Bei diesem Datensatz änern wir zuerst die "type" Spalte wie oben in einen Faktor.
```{r}
#Type in Faktor umwandeln
card <- card %>%
  rename(card_type = type)

card <- card %>% 
  mutate(card_type = as.factor(card_type))
```

Anschliessend wird die spalte "issued" bearbeitet. Bei dieser sollen die ersten sechs Zeichen als Datum gewertet werden. Die 00:00:00 benötigen wir dabei nicht mehr, da diese bei allen Daten hintendran stehen.
```{r}
# Datum umwandeln
card$issued <- ymd(substr(card$issued, 1, 6))
```

Der Card Datensatz sollte nun korrekt sein.
```{r}
glimpse(card)
summary(card)
```
```{r}
card %>%
  group_by(card_type) %>%
  summarise(count = n())
```

## client Datensatz
```{r}
client <- read.csv("data/client.csv", sep=";")
glimpse(client)
summary(client)
sum(is.na(client))
length(unique(client$client_id)) == nrow(client)
```

Bei diesem Datensatz ist wichtig zu wissen, dass in der birth_number zudem das Geschlecht gespeichert ist. Bei Frauen wurde die angabe des Monats um 50 erhöht. D.h YYMMDD für Männer und YYMM+50DD für Frauen. Deshalb wollen wir eine zusätzliche Spalte für das Geschlecht erzeugen und die Geburtsdaten dann bereinigt in der birth number wiedergeben.
```{r}
#Unterscheidung von Mann und Frau anhand vom Geburtsdatum
client <- client %>%
  mutate(
    sex = ifelse((birth_number %% 10000) > 2000, "female", "male")
  )

#Ändern des Datentyps der Reihe
client <- client %>% 
  mutate(sex = as.factor(sex))
```

Da wir nun die Kategorie des Geschlechts haben wollen wir noch das Geburtsdatum anpassen und im richtigen Format ausgeben.
```{r}
#Geburtsdatum bei den Frauen um 5000 subtrahieren. Damit wieder der normale Monat angezeigt wird.
client$birth_number[client$sex == "female"] <- client$birth_number[client$sex == "female"]-5000


#Der <int> wird in ein Datum umgewandelt.
client <- client %>%
  mutate(birth_number = birth_number + 19000000)
client$birth_number <- ymd(client$birth_number)

client <- client %>%
  rename(birthday = birth_number,
         district_id_client = district_id)

client$year <- year(client$birthday)
```

Der Client Datensatz sollte nun korrekt sein und die Spalte sex enthalten.
```{r}
glimpse(client)
summary(client)
```
```{r}
 install.packages("ggridges")
 library(ggridges)

ggplot(client, aes(x = year, y = sex, fill = sex)) +
  geom_density_ridges() +
  theme_ridges() +  # This is a theme provided by ggridges
  labs(title = "Ridge Line Plot of Year by Sex",
       x = "Year",
       y = "Sex")

ggplot(client, aes(x = year, y = district_id_client)) +
  geom_point() +  # Adds the data points
  geom_smooth(method = "lm",   # lm for linear model
              se = TRUE,       # se = TRUE to show confidence interval
              color = "blue", 
              fill = "lightblue") +
  theme_minimal() +
  labs(title = "Regression of District ID on Year with Confidence Interval",
       x = "Year",
       y = "District ID")

ggplot(client, aes(x = year, y = district_id_client, color = sex)) + 
  geom_point() +
  theme_minimal() +
  labs(title = "Scatter Plot by Year and District ID",
       x = "Year",
       y = "District ID",
       color = "Sex") +
  theme(legend.position = "bottom")

ggplot(client, aes(x = district_id_client, y = year, color = sex, size = year)) + 
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(title = "Bubble Chart by Year and District ID",
       x = "Year",
       y = "District ID",
       color = "Sex",
       size = "Year") +
  theme(legend.position = "bottom")

ggplot(client, aes(x = sex, y = year, color = sex)) + 
  geom_violin(trim = FALSE) + 
  geom_jitter(width = 0.2, alpha = 0.5) +
  theme_minimal() +
  labs(title = "Violin and Scatter Plot by Year and Sex",
       x = "Sex",
       y = "Year")

ggplot(client, aes(x = sex, y = year, color = sex)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +
  theme_minimal() +
  labs(title = "Categorical Strip Plot with Jitter",
       x = "Sex",
       y = "Year")

ggplot(client, aes(x = year, fill = sex)) +
  geom_density(alpha = 0.7) +
  theme_minimal() +
  labs(title = "Conditional Density Plot of Year by Sex",
       x = "Year",
       y = "Density")
```

## disp Datensatz
```{r}
disp <- read.csv("data/disp.csv", sep=";")
glimpse(disp)
summary(disp)
sum(is.na(disp))
length(unique(disp$disp_id)) == nrow(disp)
```

Hier wollen wir nur den type von <chr> in <fct> ändern und anschliessend kontrollieren.
```{r}
#Type in Faktor umwandeln
disp <- disp %>% 
  mutate(type = as.factor(type))

#Ausgabe von disp zur Kontrolle
glimpse(disp)
summary(disp)
```

## district Datensatz
```{r}
district <- read.csv("data/district.csv", sep=";")
glimpse(district)
summary(district)
sum(is.na(district))
length(unique(district$A1)) == nrow(district)
```

Hier werden alle Spalten mit A angegeben, dies sollen aussagekräftigere Namen werden.
```{r}
#Spaltennamen ändern
colnames(district) <- c("district_id", "district_name", "region", "inhabitants", "municipalities<499", "municipalities500-1999", "municipalities2000-9999", "municipalities>10000", "cities", "urban_inhabitants", "average_salary", "unemploymant_rate_95", "unemploymant_rate_96", "enterpreneurs_per_1000", "commited_crimes_95", "commited_crimes_96")
```

Nun sollen noch alle <chr> in andere Formate geändert werden. Die Warnung nach ausführung des Codes ist auf den District Jesenik bezogen. Dort ist in der Spalte unemploymant_rate_95 und commited_crimes_95 ein "?" eigetragen, dieser Wert wird mit NA ersetzt.
```{r}
district <- district %>% 
  mutate(district_name = as.factor(district_name),
        region = as.factor(region),
        unemploymant_rate_95 = as.double(unemploymant_rate_95),
        commited_crimes_95 = as.integer(commited_crimes_95))

```

Kontrolle der geänderten Tabelle.
```{r}
glimpse(district)
summary(district)
```
```{r}
district <- district %>%
  mutate(crimes_per_1000_1995 = commited_crimes_95/inhabitants*1000)

ggplot(district, aes(x = unemploymant_rate_96, y = crimes_per_1000_1995)) +
  geom_point(alpha = 0.5) +
  labs(title = "Scatter Plot of Unemployment Rate and Committed Crimes in 1995",
       x = "Unemployment Rate in 1995",
       y = "Committed Crimes per 1000 in 1995")
```
```{r}
district <- district %>%
  mutate(crimes_per_1000_1996 = (commited_crimes_96/inhabitants)*1000)

ggplot(district, aes(x = unemploymant_rate_96, y = crimes_per_1000_1996)) +
  geom_point(alpha = 0.5) +
  labs(title = "Scatter Plot of Unemployment Rate and Committed Crimes in 1996",
       x = "Unemployment Rate in 1996",
       y = "Committed Crimes per 1000 in 1996")
```
```{r}
district %>%
  filter(commited_crimes_95 == 85677)

district %>%
  filter(commited_crimes_96 == 99107)
```
```{r}
ggplot(district, aes(x = inhabitants, y = commited_crimes_95)) +
  geom_point(alpha = 0.5) +
  labs(title = "Scatter Plot of Inhabitants vs Crimes in 95",
       x = "Number of Inhabitants",
       y = "Number of Crimes")

ggplot(district, aes(x = inhabitants, y = commited_crimes_96)) +
  geom_point(alpha = 0.5) +
  labs(title = "Scatter Plot of Inhabitants vs Crimes in 96",
       x = "Number of Inhabitants",
       y = "Number of Crimes")
```

## loan Datensatz
```{r}
loan <- read.csv("data/loan.csv", sep=";")
glimpse(loan)
summary(loan)
sum(is.na(loan))
length(unique(loan$loan_id)) == nrow(loan)
```

Ändern der Spalte status, A, B, C,D soll mit aussagekräftigeren Namen ersetzt werden, anschiessend soll sie noch zu <fct> geändert werden.
```{r}
#Ändern der Namen in Status
loan <- loan %>%
  mutate(status = case_when(status == "A" ~ "finished_ok",
                   status == "B" ~ "finished_not_payed",
                   status == "C" ~ "running_ok",
                   status == "D" ~ "running_client_in_dept"))

#Status in Faktor ändern
loan <- loan %>%
  mutate(status = as.factor(status))

loan <- loan %>%
  rename(date_loan = date,
         loan_date = date)

```

Kontrolle der Änderungen.
```{r}
glimpse(loan)
summary(loan)
```

## order Datensatz
```{r}
order <- read.csv("data/order.csv", sep=";")
glimpse(order)
summary(order)
sum(is.na(order))
length(unique(order$order_id)) == nrow(order)
```

Hier sollen die beiden <chr> in <fct> geändert werden. Auch sollen die Werte in k_symbol verständlich werden.
```{r}
#K_symbol Werte verständlich machen
order <- order %>%
  mutate(k_symbol = case_when(k_symbol == "POJISTNE" ~ "insurrance payment",
                           k_symbol == "SIPO" ~ "household",
                           k_symbol == "LEASING" ~ "leasing",
                           k_symbol == "UVER" ~ "loan payment",
                           k_symbol == " " ~ NA,))

#Umwandlung in Faktor
order <- order %>%
  mutate(bank_to = as.factor(bank_to),
         k_symbol = as.factor(k_symbol))
```

Kontrolle der Daten.
```{r}
glimpse(order)
summary(order)
```

## trans Datensatz
```{r}
trans <- read.csv("data/trans.csv", sep=";")
glimpse(trans)
summary(trans)
sum(is.na(trans))
sum(is.na(trans$trans_id))
length(unique(trans$trans_id)) == nrow(trans)
```

Ändern der Tschechischen Namen, date in Datum formatieren und umwandlungen in Faktoren. Bei der spalte type werden in der Datenbeschreibung nur "PRIJEM" und "VYDAJ" beschrieben zudem kommt aber auch noch "VYBER" vor, dieser wird aber ansonsten als "withdrawal in cash" beschrieben, deshalb übernehmen wir dies auch hier.
```{r}
# Type Werte verständlich machen
trans <- trans %>%
  mutate(type = case_when(type == "PRIJEM" ~ "credit",
                          type == "VYDAJ" ~ "withdrawal",
                          type == "VYBER" ~ "withdrawal in cash"))

# Operation Werte verständlich machen
trans <- trans %>%
  mutate(operation = case_when(operation == "VYBER KARTOU" ~ "creditcard withdrawal",
                               operation == "VKLAD" ~ "credit in cash",
                               operation == "PREVOD Z UCTU" ~ "collection from another bank",
                               operation == "VYBER" ~ "withdrawal in cash",
                               operation == "PREVOD NA UCET" ~ "remittance to another bank"))


# K_symbol Werte verständlich machen
trans <- trans %>%
  mutate(k_symbol = case_when(k_symbol == "POJISTNE" ~ "insurrance payment",
                              k_symbol == "SLUZBY" ~ "paymant for statement",
                              k_symbol == "UROK" ~ "interest credited",
                              k_symbol == "SANKC. UROK" ~ "sanction interest if negative balance",
                              k_symbol == "SIPO" ~ "household",
                              k_symbol == "DUCHOD" ~ "old age pension",
                              k_symbol == "UVER" ~ "loan payment"))

# Datum umwandeln
trans$date <- ymd(trans$date)

# Ändern in <fct>
trans <- trans %>%
  mutate(type = as.factor(type),
         operation = as.factor(operation),
         k_symbol = as.factor(k_symbol),
         bank = as.factor(bank))

trans <- trans %>%
  rename(
    balance_after_transaction = balance,
    account_receiver = account,
    bank_receiver = bank,
  )
```

Kontrolle der Änderungen
```{r}
glimpse(trans)
summary(trans)
```
# CAR




```{r}
client_analytical_record <- accounts %>%
  left_join(disp %>% filter(type == "OWNER") %>%
              rename_with(~paste0("owner_", .), -account_id), by = "account_id") %>%
  left_join(disp %>% filter(type == "DISPONENT") %>%
              rename_with(~paste0("user_", .), -account_id), by = "account_id")


client_analytical_record <- client_analytical_record %>%
  select(-owner_type, -user_type) %>%
  replace_na(list(
    user_disp_id = -1, 
    user_client_id = -1
  ))

client_analytical_record <- client_analytical_record %>%
  left_join(client, by = c("owner_client_id" = "client_id"))

client_analytical_record <- client_analytical_record %>%
  rename(
    owner_birthday = birthday,
    owner_district_id = district_id_client,
    owner_sex = sex
  )

client_analytical_record <- client_analytical_record %>%
  left_join(client, by = c("user_client_id" = "client_id"))

client_analytical_record <- client_analytical_record %>%
  rename(
    user_birthday = birthday,
    user_district_id = district_id_client,
    user_sex = sex
  )

client_analytical_record <- client_analytical_record %>%
  left_join(district, by = c("owner_district_id" = "district_id"))

glimpse(client_analytical_record)
```

Neues Dataframe erstellen mit account ID zum Joinen und monatliche ausgaben und einnahmen einzelner accounts ende Monat erstellen.

```{r}
trans_per_month <- trans %>%
  mutate(year_month = floor_date(date, unit = "month")) %>%
  group_by(account_id, year_month) %>%
  summarise(
    einnahmen = sum(amount[type == "credit"]),
    ausgaben = sum(amount[type == "withdrawal in cash" | type == "withdrawal"]), .groups = "drop"
    )
```

