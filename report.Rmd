---
title: "Cross-selling in Banking"
author: Adrian Meier, Benjamin Wuermli
output: html_notebook
---
```{r}
install.packages("tidyverse") 
```
```{r}
library(tidyverse)
```


This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

Laden und betrachten der account Tabelle.
```{r}
accounts <- read.csv("data/account.csv", sep=";")
glimpse(accounts)
summary(accounts)
sum(is.na(accounts))
length(unique(accounts$account_id)) == nrow(accounts)
```

Im ersten schritt wollen wir die Daten der Tabelle accounts verständlicher machen. Dabei wollen wir die tschechischen Namen in der Kategorie "frequency" auf Deutsch übersetzen und con einem <chr> in einen <fct> umwandeln  und das Datum in das richtige Format bringen.
```{r}
#Ändern der tschechischen Namen in der Spalte frequency
accounts <- accounts %>%
  mutate(frequency = case_when(frequency == "POPLATEK MESICNE" ~ "Monatliche Ausgabe",
                               frequency == "POPLATEK TYDNE" ~ "Wöchentliche Ausgabe",
                               frequency == "POPLATEK PO OBRATU" ~ "Ausgabe nach Transaktion"))
```

```{r}
#Frequency in Faktor umwandeln
accounts <- accounts %>% 
  mutate(frequency = as.factor(frequency))
```

```{r}
# Datum umwandeln
accounts$date <- ymd(accounts$date)
```

Die Werte sind nun bereinigt und man sieht bei frequency die drei Ausgabedaten, zudem ist das Datum nun auch als Datum erfasst.
```{r}
glimpse(accounts)
summary(accounts)
```



Laden und betrachten der card Tabelle
```{r}
card <- read.csv("data/card.csv", sep=";")
glimpse(card)
summary(card)
sum(is.na(card))
length(unique(card$card_id)) == nrow(card)
```

Bei diesem Datensatz änern wir zuerst die "type" Spalte wie oben in einen Faktor.
```{r}
#Type in Faktor umwandeln
card <- card %>% 
  mutate(type = as.factor(type))
```

Anschliessend wird die spalte "issued" bearbeitet. Bei dieser sollen die ersten sechs Zeichen als Datum gewertet werden. Die 00:00:00 benötigen wir dabei nicht mehr, da diese bei allen Daten hintendran stehen.
```{r}
# Datum umwandeln
card$issued <- ymd(card$issued)
```

Der Card Datensatz sollte nun korrekt sein.
```{r}
glimpse(card)
summary(card)
```

Weiter geht es mit dem Client Datensatz.
```{r}
client <- read.csv("data/client.csv", sep=";")
glimpse(client)
summary(client)
sum(is.na(client))
length(unique(client$client_id)) == nrow(client)
```

Bei diesem Datensatz ist wichtig zu wissen, dass in der birth_number zudem das Geschlecht gespeichert ist. Bei Frauen wurde die angabe des Monats um 50 erhöht. D.h YYMMDD für Männer und YYMM+50DD für Frauen. Deshalb wollen wir eine zusätzliche Spalte für das Geschlecht erzeugen und die Geburtsdaten dann bereinigt in der birth number wiedergeben.
```{r}
#Unterscheidung von Mann und Frau anhand vom Geburtsdatum
sex_in_birth <- function(zahl) {
  einzelne_zahl <- as.numeric(strsplit(as.character(zahl), '')[[1]])    # <int> in <str> ändern
  mittlere_zahl <- as.integer(einzelne_zahl[3])                                    # 3. Zahl aussuchen
  geschlecht <- ifelse((mittlere_zahl) > 2, "female", "male")           # Wenn die Zahl grösser als 2 ist (Kein Monat wird mit 20+ angegeben) als Frau ausgeben.
  return(geschlecht)
}

#Anwendung der Funktion auf den Datensatz und erstellung der zusätzlichen Reihe
client$sex <- sapply(client$birth_number, sex_in_birth)

#Ändern des Datentyps der Reihe
client <- client %>% 
  mutate(sex = as.factor(sex))
```

Da wir nun die Kategorie des Geschlechts haben wollen wir noch das Geburtsdatum anpassen und im richtigen Format ausgeben.
```{r}
#Geburtsdatum bei den Frauen um 5000 subtrahieren. Damit wieder der normale Monat angezeigt wird.
client$birth_number[client$sex == "female"] <- client$birth_number[client$sex == "female"]-5000


#Der <int> wird in ein Datum umgewandelt.
client <- client %>%
  mutate(birth_number = birth_number + 19000000)
client$birth_number <- ymd(client$birth_number)
```

Der Client Datensatz sollte nun korrekt sein und die Spalte sex enthalten.
```{r}
glimpse(client)
summary(client)
```

Als nächstes soll der disp Datensatz eingelesen werden.
```{r}
disp <- read.csv("data/disp.csv", sep=";")
glimpse(disp)
summary(disp)
sum(is.na(disp))
length(unique(disp$disp_id)) == nrow(disp)
```

Hier wollen wir nur den type von <chr> in <fct> ändern und anschliessend kontrollieren.
```{r}
#Type in Faktor umwandeln
disp <- disp %>% 
  mutate(type = as.factor(type))

#Ausgabe von disp zur Kontrolle
glimpse(disp)
summary(disp)
```

Nun wird der District Datensatz geladen.
```{r}
district <- read.csv("data/district.csv", sep=";")
glimpse(district)
summary(district)
sum(is.na(district))
length(unique(district$A1)) == nrow(district)
```

Hier werden alle Spalten mit A angegeben, dies sollen aussagekräftigere Namen werden.
```{r}
#Spaltennamen ändern
colnames(district) <- c("district_id", "district_name", "region", "inhabitants", "municipalities<499", "municipalities500-1999", "municipalities2000-9999", "municipalities>10000", "cities", "urban_inhabitants", "average_salary", "unemploymant_rate_95", "unemploymant_rate_96", "enterpreneurs_per_1000", "commited_crimes_95", "commited_crimes_96")
```

Nun sollen noch alle <chr> in andere Formate geändert werden. Die Warnung nach ausführung des Codes ist auf den District Jesenik bezogen. Dort ist in der Spalte unemploymant_rate_95 und commited_crimes_95 ein "?" eigetragen, dieser Wert wird mit NA ersetzt.
```{r}
district <- district %>% 
  mutate(district_name = as.factor(district_name),
        region = as.factor(region),
        unemploymant_rate_95 = as.double(unemploymant_rate_95),
        commited_crimes_95 = as.integer(commited_crimes_95))

```

Kontrolle der geänderten Tabelle.
```{r}
glimpse(district)
summary(district)
```

Laden des loan Datensatzes.
```{r}
loan <- read.csv("data/loan.csv", sep=";")
glimpse(loan)
summary(loan)
sum(is.na(loan))
length(unique(loan$loan_id)) == nrow(loan)
```

Ändern der Spalte status, A, B, C,D soll mit aussagekräftigeren Namen ersetzt werden, anschiessend soll sie noch zu <fct> geändert werden.
```{r}
#Ändern der Namen in Status
loan <- loan %>%
  mutate(status = case_when(status == "A" ~ "finished_ok",
                   status == "B" ~ "finished_not_payed",
                   status == "C" ~ "running_ok",
                   status == "D" ~ "running_client_in_dept"))

#Status in Faktor ändern
loan <- loan %>%
  mutate(status = as.factor(status))
```

Kontrolle der Änderungen.
```{r}
glimpse(loan)
summary(loan)
```

Laden der order Datei.
```{r}
order <- read.csv("data/order.csv", sep=";")
glimpse(order)
summary(order)
sum(is.na(order))
length(unique(order$order_id)) == nrow(order)
```

Hier sollen die beiden <chr> in <fct> geändert werden. Auch sollen die Werte in k_symbol verständlich werden.
```{r}
#K_symbol Werte verständlich machen
order <- order %>%
  mutate(k_symbol = case_when(k_symbol == "POJISTNE" ~ "insurrance payment",
                           k_symbol == "SIPO" ~ "household",
                           k_symbol == "LEASING" ~ "leasing",
                           k_symbol == "UVER" ~ "loan payment",
                           k_symbol == " " ~ NA,))

#Umwandlung in Faktor
order <- order %>%
  mutate(bank_to = as.factor(bank_to),
         k_symbol = as.factor(k_symbol))
```

Kontrolle der Daten.
```{r}
glimpse(order)
summary(order)
```

Laden der trans Datei.
```{r}
trans <- read.csv("data/trans.csv", sep=";")
glimpse(trans)
summary(trans)
sum(is.na(trans))
sum(is.na(trans$trans_id))
length(unique(trans$trans_id)) == nrow(trans)
```

Ändern der Tschechischen Namen, date in Datum formatieren und umwandlungen in Faktoren. Bei der spalte type werden in der Datenbeschreibung nur "PRIJEM" und "VYDAJ" beschrieben zudem kommt aber auch noch "VYBER" vor, dieser wird aber ansonsten als "withdrawal in cash" beschrieben, deshalb übernehmen wir dies auch hier.
```{r}
# Type Werte verständlich machen
trans <- trans %>%
  mutate(type = case_when(type == "PRIJEM" ~ "credit",
                          type == "VYDAJ" ~ "withdrawal",
                          type == "VYBER" ~ "withdrawal in cash"))

# Operation Werte verständlich machen
trans <- trans %>%
  mutate(operation = case_when(operation == "VYBER KARTOU" ~ "creditcard withdrawal",
                               operation == "VKLAD" ~ "credit in cash",
                               operation == "PREVOD Z UCTU" ~ "collection from another bank",
                               operation == "VYBER" ~ "withdrawal in cash",
                               operation == "PREVOD NA UCET" ~ "remittance to another bank"))


# K_symbol Werte verständlich machen
trans <- trans %>%
  mutate(k_symbol = case_when(k_symbol == "POJISTNE" ~ "insurrance payment",
                              k_symbol == "SLUZBY" ~ "paymant for statement",
                              k_symbol == "UROK" ~ "interest credited",
                              k_symbol == "SANKC. UROK" ~ "sanction interest if negative balance",
                              k_symbol == "SIPO" ~ "household",
                              k_symbol == "DUCHOD" ~ "oldage pension",
                              k_symbol == "UVER" ~ "loan payment"))

# Datum umwandeln
trans$date <- ymd(trans$date)

# Ändern in <fct>
trans <- trans %>%
  mutate(type = as.factor(type),
         operation = as.factor(operation),
         k_symbol = as.factor(k_symbol),
         bank = as.factor(bank))
```

Kontrolle der Änderungen
```{r}
glimpse(trans)
summary(trans)
```

